// SPDX-License-Identifier: UNLICENSED
pragma solidity >=0.8.18;

import {Test} from "forge-std/Test.sol";

import {Decoder} from "@aztec3/core/Decoder.sol";
import {Rollup} from "@aztec3/core/Rollup.sol";

contract DecodeHelper is Decoder {
  function decode(bytes calldata _l2Block)
    external
    pure
    returns (uint256, bytes32, bytes32, bytes32)
  {
    return _decode(_l2Block);
  }

  function computeDiffRoot(bytes calldata _l2Block) external pure returns (bytes32) {
    return _computeDiffRoot(_l2Block);
  }
}

// Blocks generated with https://gist.github.com/LHerskind/dccc762ee539b7b0984bf51af6f51dbb
contract DecoderTest is Test {
  Rollup internal rollup;
  DecodeHelper internal helper;

  bytes block_1 =
    hex"0000000100000000026d27850fe7ca39749085f2a0dbde5776a38f37c982f024c4faec2cd51256a60000000092fda1d4e2f4d04645a5afab97c83831498573057c6274f975881bb93b16b0d60000000090e5ba6910314bb2d7175be5ab6cdd176bde431d3d9cc7ce2672c468ca57aab6000000008071532a7f22610b60a373b954208a01dc1058934e174c241a4825e1b04a59040000000055bcd75383e3c233124ca4b26857cf9d8474c78a063ceedd507726a7bc13254400000020496c61142f126c578fa762940fce65490ecb9dbb408a66b9275601725b16b827000000207728207bac279dbf8b7b5652b8b8c3619f65d007a7534015d0daf0a960e1550d00000008a71730065c0684ba4aa476b4ab3494db58b08ef8813cd0d4a456553ac046bf7a0000000172c52733e1b74bb841e89cfb2f9f6f08956d7d6c685073326442792d88e9cd1b000000019deecf3cb56703b46813472708f3085f00df5371fc20312b815063fa93ac55240000002004cf027a8ea6e124d01b5254a7c75f10aa2c849c016d3c7178f2f5b1b179c9e8830ffba67f219f3effa813a4669c84dec9b19c59c7dbbdc90a2b9ff701ff5045c7f12f133011953b37eb73a884c81b38d9b2ace4b224f81e6999a24b2f482e6a051742efabc5bf8b8649c6ca15ae9ae240483e6e64618ce2754c26d9a2bf2c5c780c2a3ff698bc4c750d5ff8fa74036e5562e8d89890c2dacb6d700f6b12f7dacfecafccd86a18d427d84d4bb8e0719feddd0bd4c248cff5889bb7e475e568784bdb542193a2752c78984436e8033e27030f1367819db683f004942872d3ef1c64dcd775fd8941913a85c0793160540be74e880dcf0649e3811d41d8eddaf1c3f8e487b4111d92ef95b7dd49fdc1591d17a9e5cc18eb547b318b09423c4a84131350f4b91f3c164aff80fe8e90c0a5e42d238fbddc22c0d89a510c1fea0839fedd1823ea7ec85c12461455881532f0fadc1786575ac924cfcc4edc44b4f8cd33ae54270c59b8d76198cc830453034e3a51dc30f6f5628b61c2467670de2dba1768a36430479247742a2238159cfb6328c3f27406d06d196319a993121ac74a89278d21b6e5cc1630f8929f5459a7038378814113a4d28712c670241ec3f76b85ac52e31dc9e22d55d290076829d9562c4e14ffccbeb9368c3ddc9eabf502b8e151a174b3bdbc202f98e4159b5be14fd57bc794523e9b305a284efaff9d06b5507829918a5292f07d2af3786ea18b46783b214ce79d8aaf3f25f05769cbae80bd7d211e94158f08a82cc1e745998074434360473dfa3145c368b08099578f356ea1b726e45ffda553180cd8f867c1656cdee5bd93513a745e7f4db6c78be52463088865aca180f5a5b241883c799d080d9af89cc7255b22ca9e007c54120e6b2d167bb9aa784941eeaea077e688f78c57c8460a2de65a5d6c0e18c751f301a691f1ede68c63593015ac2bc4867438a9082f4eed9778735ba5efe4f40b88af2b874951c60f1e1c89308684a3ef513589ff4f167e8471fbefa9eecc22de2d575625e87f8afb4fc5725780971dc16714d799c6563a7e8f603152aec76143efda4e7a8d72c82aa1a086e4545839636489815beeed36a17d744adc90ff20600691af9f74b64f3d5e83bb78bfbcbb31f969d01ba4e248737839afdc448ad3596fb2c464189b25c23038e1212710bd0667b3ef8ce232ffdeeeb1333d34d96f4c0713e39393e7d4bc660ec93c1c6d7fee494b10116f0380296c91d044b4d2ecb15294b520b8df116d106a42d9a460b6689f56fe8cac679e784ba7c8e64cc954b1ddfc8d811d2a45db2b3ef41269853dfc835fc2cab2d57e90494bf8250c6b90ed87477b1de6f28418e5c7a820aae2b4a1ce80c3f2807f1134e516371c997a414b790a65987e43ad32ab2182a0bc5772f9e42fad34319695e3857152040ab8c0bd64f18f33000000201ce5a42ecad03ede45ee270fd83aaab4bcb5bb11650a3f3cbb0a5b3266e676badba6aed51f14f10aacdaa9969745085353c0daf62dcd0cdaf56b7d8fac4a6a875c014e536d128d30cc6e184f7e4c88c6653aeb98732d82eb04eb9776b798707c461d8fb1bbcc44fe3db8d3845edb9ed468e0ea360b71c3354335d740069f4ec9764291034a710d6ee9845cd37d283153e70d4c85c6ecb202d5b76c5d9885afbcb8daf4c354e7772bbd880e86c3caaf527c9e37d80136285d05c4918d0e469b9a1e8d389d91cf64978d20175de676635e2915c619367e5093b6bd4aed7de6368ed77715c112d9b47d0e3597e1cf250a7e9ccc7c2919c584f62ad3499c6ed42d243c32ef99a2033d3bcaa5014188ca3a93376c1e08e47b48e1a6fc5a27c5e5dd7bbd7dbdd5020f29b66cd21d05a589cd704dbb1d4cf220fda802308472b786acd9346ce2999ffc43ebee8b46e40eef7aa41f88effe0a45c1d45245ac4109ef429cf0a59be7d0784d55cd25a4165a53f741d96a96b4358684d0280fbb8af43cf6afd59522e2f7ff1896296a560b1ed4e9532b41cc8d83c1e62b8b9d8e5d92561a66c9c9b661d27edf5b93931b95abb047650f3ab9d169d5c145d0325c4e913903987f3342cf3761bbcf58724fc13761114c97eaeabdc6d578c8ee39493377e6ae50bd6441f7334b57a96d9a0a6fce410de5d2aea385ee8c82788d3f3901278d49e101ed81d2ae4578d949a0fcf400ec9357c1e7d957c214b9e0b248aef8fdfd4ca50a039b493d87e5b41dde5f2ae56faa39547c924877f00ef56eb0b322c3f52bc1d47dcd12baafabab9f32311f355674550d0fbe51cb47c3ebbdfb9ef02713476f6aec98d64d596126146a4944fd6277065c692c726d6da6eefbd99852dc81765f278af17b49440a2b2730b76ea84cfaaf08a62de1124668551f6f3cc2a33d5d12796883693224bd43e70a979b900e88cc2c24d3db53bdcd82aa17a047674a5eb45a874a95186df03a4eac54a434b7b87943e5acd9561c9e09513f1bb60d96c0472faba31dc35d73affd2ae0757f07cfc23dc6c9e2c4dff4945d46f9d52e8bd9c74aca381af2e59f41640b14898a8f75adf7cfbc6c105844b580fcbc59a4c1f5e315beda39680ff392963fa4551a62e87feda484215a804ea4af55c52c6d7f77c3876615dc42e6476fd974e405fd2d16c086856fc1ad9420a581b770e9cbb807e6f171a2e3c491ac66de2b1adbc0ee3fd18277737340aa9b310342db71f344ac4f10b63cb23d5dd6de4a3566f1e948cddbed83538a7e3450c4870cd26da87e23c0bf66a5f5aa22fbd56984776ecbefbfbe276143d1fdabc2be4893c4cf438c8fea24dca9bcc03a076c56da333cc05213aa27c0f2aeea7583d499e62dbb84eabf6113e8a444dd3c3a04b09263bfe3248780c97ef8c5a6654a7f7c20729fb1a6c82e00000008fc7168914fb3f34b544b555c3079e18f0716b2e43062e1950d3a172dd2cc4e096d91f2f077802f217a1ba3f1b0c58bdb043914986e2ab375c2b2fc9cc069d09ec7b9f210134fce1e78b70e9f9f2a2ac4514bab668e99f0d0106006a62dbbf708fb5175774909691ff8fefd94a11bb37c3818ceb9e3335d7085bcbeb0cc8bf656985fcb53efd11f7e8808aacd0c7c5f244271aeb342f0f12656659960090926f31a61aef1c654db3b36b53d03453288fd92bcb30aefd36460330be3b9814669645e9344aa54e1deda1016d4ef3b3ae6c9da8c0ad19db46ad28bac03d34d7166b6fe280594b84df03effd72731c2f5d92dd2bae2b06ce45832bb3b7e9ae0041166d2a4c0c019fb4c3c865803a447b3895a18d456c66abfab8899db9c3d38b9af457feeae39874c79a99a998a31c0accf85edb4b8e9810f843ac6b8f7200760e95b2d5e0e34105fb39c2a7066865523132cdd40d0cd2f6aef3948e85259513b383a7a6db167d1804d93c99eb78c317288b4ebae14854b841b9825923812f9293d3d85e3942835f3cab7170a5c61bcb021b1cf773e1fe652381fad61f4cb4a43465b630212ca6e0223c2d20f30bc374e78fc79ec8d4fbeb4eae6d431ec0d306ccca543d0ab9ea6fe1724e1cef669e9254c8e036e0d856e241521e33bde0551e84260a5dd29fec18c1716f9a5e7bbc74eabc4dcee065c3770aa78bcb8404408e1b436f23cc3451811f331e0f75c607710a0838a42a373a690dc352d06dd4f5d21388de63678f61b6d02d8f3e9fe7e8a1e64c1a441df94a83295d6f6609580871767d29294e57e943895bf3b85a8b6ea33932379943e80e689b80455026dfe6a5d2f0544c25ee0f11d89d1bef2832080d95c4d39f6048b7e0db6d771154a321d2979ed36bcc70a9ea2fb3583844ff30a11a80197225cf7d1a7e8e4cef24f443c13ff08";
  bytes block_2 =
    hex"0000000200000020496c61142f126c578fa762940fce65490ecb9dbb408a66b9275601725b16b827000000207728207bac279dbf8b7b5652b8b8c3619f65d007a7534015d0daf0a960e1550d00000008a71730065c0684ba4aa476b4ab3494db58b08ef8813cd0d4a456553ac046bf7a0000000172c52733e1b74bb841e89cfb2f9f6f08956d7d6c685073326442792d88e9cd1b000000019deecf3cb56703b46813472708f3085f00df5371fc20312b815063fa93ac552400000020496c61142f126c578fa762940fce65490ecb9dbb408a66b9275601725b16b827000000207728207bac279dbf8b7b5652b8b8c3619f65d007a7534015d0daf0a960e1550d00000008a71730065c0684ba4aa476b4ab3494db58b08ef8813cd0d4a456553ac046bf7a000000022165eb4c24ae6094baac7030a5c34975363d08dffee879e7a977245dc4329755000000024cd0efa11cdedc2f673b57e9b016717b1111854fa17b6cb4385c09eab4f676fe000000000000000000000000";

  bytes block_empty =
    hex"000000010dab4f2c5004966607528e2de5e46abc49d68ac863a6f3ad3e3d98332ca8989d000000000d4ee51c2e3c7b242113e4cdc73af511db2393fcc96e2916ad77b07d4dd2ee96000000082c21cd9d652b1d55ae6437893ec4189d5cc48db60f44ecd0ce272e3a0fef45360000000011418b0f96de397c0bdec2dda6dc049c9f9715fa62420e5a6e08f3dd0b68fd36000000012ccf6631cb5d548aa25e0c51b9398c89af35fb00b321d40db6cb8f13f44cce2f000000010dab4f2c5004966607528e2de5e46abc49d68ac863a6f3ad3e3d98332ca8989d000000100d4ee51c2e3c7b242113e4cdc73af511db2393fcc96e2916ad77b07d4dd2ee96000000182c21cd9d652b1d55ae6437893ec4189d5cc48db60f44ecd0ce272e3a0fef4536000000042fe07d4d766850fb0c5f289cb6d71334e2f662146dd7e9693351795a6233b2d00000000211fcecd075e7e86da01708dedfc9671475fe7a879e076d6fe67bf432347eb0300000000200000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

  function setUp() public {
    rollup = new Rollup();
    helper = new DecodeHelper();
  }

  function testDecoderDiffRoot() public {
    bytes32 diffRoot = helper.computeDiffRoot(block_1);
    assertEq(
      0x260777a20fee44e43d74c60350ebb7a631dabe0a8a1c27ee9a8264b2f5c24c2d,
      diffRoot,
      "Invalid diff root"
    );
  }

  function testDecoder() public {
    rollup.process(bytes(""), block_1);
    rollup.process(bytes(""), block_2);
  }

  function testPublicInputHash() public {
    (uint256 l2BlockNumber, bytes32 oldStateHash, bytes32 newStateHash, bytes32 publicInputsHash) =
      helper.decode(block_empty);
    assertEq(
      publicInputsHash,
      0x181161b4d0484ce98066b1c36289b0327f8782e9bc41f25ba77302511a2bd16b,
      "Invalid public input hash"
    );
  }
}
