#!/usr/bin/env bash

echo âœ¨ System Info  
sw_vers
echo âœ¨ System Details
uname -a
echo âœ¨ LLVM Version
llvm-config --version

echo âœ¨ CMAKE_CXX_COMPILER=$CMAKE_CXX_COMPILER
echo âœ¨ CMAKE_C_COMPILER=$CMAKE_C_COMPILER

# llvm@11 paths
export CC=/usr/local/opt/llvm@11/bin/clang
export CXX=/usr/local/opt/llvm@11/bin/clang++

export PATH="/usr/local/opt/llvm@11/bin:$PATH"
export LDFLAGS="-L/usr/local/opt/llvm@11/lib"
export CPPFLAGS="-I/usr/local/opt/llvm@11/include"

echo âœ¨ clang -v
clang -v
echo âœ¨ clang++ -v
clang++ -v

echo âœ¨ LD_LIBRARY_PATH=$LD_LIBRARY_PATH

echo âœ¨ CC=$CC
echo âœ¨ CXX=$CXX
echo âœ¨ LIBS=$LIBS

# fix clang path's to bb expectations
sudo mkdir -p /usr/local/opt/llvm/bin/
sudo ln -s $(which $CC) /usr/local/opt/llvm/bin/clang
sudo ln -s $(which $CXX) /usr/local/opt/llvm/bin/clang++

#fix libomp path
sudo mkdir -p /usr/local/lib/
sudo ln -s /usr/local/Cellar/libomp/15.0.3/lib/libomp.a /usr/local/lib/libomp.a
ls /usr/local/Cellar/libomp/15.0.3/lib

echo âœ¨ /usr/local/opt/llvm/bin/clang --version
/usr/local/opt/llvm/bin/clang --version 
echo âœ¨ /usr/local/opt/llvm/bin/clang++ --version 
/usr/local/opt/llvm/bin/clang++ --version 

echo âœ¨ rustup target add x86_64-apple-darwin
rustup target add x86_64-apple-darwin

echo ðŸ‘· Cargo Build
cargo build --release --locked --target x86_64-apple-darwin