name: Track ACVM for Integration Tests

on:
  push:
    branches:
      - master
      - jb-track-acvm-integration-tests

jobs:
  check_and_update_version:
    runs-on: ubuntu-latest
    outputs:
      acvm_changed: ${{ steps.check_and_update_version.outputs.acvm_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check acvm version change
        run: |
          # Extract acvm version from the current Cargo.lock
          CURRENT_VERSION=$(awk '/name = "acvm"/ {getline; print $3}' Cargo.lock | tr -d '"')

          # Extract acvm version from the previous commit's Cargo.lock
          PREVIOUS_VERSION=$(git show HEAD~1:Cargo.lock | awk '/name = "acvm"/ {getline; print $3}' | tr -d '"')

          echo "Current ACVM Version: $CURRENT_VERSION"
          echo "Previous ACVM Version: $PREVIOUS_VERSION"

          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            jq '.dependencies["@noir-lang/acvm_js"] = "^'${CURRENT_VERSION}'"' compiler/integration-tests/package.json > tmp.json && mv tmp.json compiler/integration-tests/package.json
            echo "acvm_changed=true" >> $GITHUB_ENV
          else
            echo "acvm version remains the same."
            echo "acvm_changed=false" >> $GITHUB_ENV
          fi

      - name: Configure git
        if: steps.check_and_update_version.outputs.acvm_changed == 'true'
        run: |
          git config user.name kevaundray
          git config user.email kevtheappdev@gmail.com

      - name: Commit changes
        if: steps.check_and_update_version.outputs.acvm_changed == 'true'
        run: |
          git add compile/integration-tests/package.json
          git commit -m "Update ACVM version to $CURRENT_VERSION" || echo "No changes to commit"
          git push origin jb-track-acvm-integration-tests